"use strict";(()=>{var e={};e.id=3398,e.ids=[3398],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},69463:(e,t,o)=>{o.r(t),o.d(t,{headerHooks:()=>S,originalPathname:()=>I,requestAsyncStorage:()=>P,routeModule:()=>_,serverHooks:()=>b,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>E});var s,r,a,n,i={};o.r(i),o.d(i,{GET:()=>v,POST:()=>O}),o(78976);var l=o(10884),c=o(16132),p=o(88436);(function(e){e.Home="/",e.Chat="/chat",e.Settings="/settings",e.NewChat="/new-chat",e.Masks="/masks",e.Auth="/auth"})(s||(s={})),(r||(r={})).AppBody="app-body",function(e){e.Masks="masks.json",e.Prompts="prompts.json"}(a||(a={})),function(e){e.Chat="chat-next-web-store",e.Access="access-control",e.Config="app-config",e.Mask="mask-store",e.Prompt="prompt-store",e.Update="chat-update",e.Sync="sync"}(n||(n={}));let u={ChatPath:"v1/chat/completions",UsagePath:"dashboard/billing/usage",SubsPath:"dashboard/billing/subscription",ListModelPath:"v1/models"};var d=o(95798),h=o(32825),g=o.n(h);let f=process.env.PROTOCOL||"https",m=process.env.BASE_URL||"api.openai.com",y=!!process.env.DISABLE_GPT4;async function requestOpenai(e){let t=new AbortController,o=e.headers.get("Authorization")??"",s=`${e.nextUrl.pathname}${e.nextUrl.search}`.replaceAll("/api/openai/",""),r=m;r.startsWith("http")||(r=`${f}://${r}`),r.endsWith("/")&&(r=r.slice(0,-1)),console.log("[Proxy] ",s),console.log("[Base Url]",r),process.env.OPENAI_ORG_ID&&console.log("[Org ID]",process.env.OPENAI_ORG_ID);let a=setTimeout(()=>{t.abort()},6e5),n=`${r}/${s}`,i={headers:{"Content-Type":"application/json","Cache-Control":"no-store",Authorization:o,...process.env.OPENAI_ORG_ID&&{"OpenAI-Organization":process.env.OPENAI_ORG_ID}},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(y&&e.body)try{let t=await e.text();i.body=t;let o=JSON.parse(t);if((o?.model??"").includes("gpt-4"))return d.Z.json({error:!0,message:"you are not allowed to use gpt-4 model"},{status:403})}catch(e){console.error("[OpenAI] gpt4 filter",e)}try{let e=await fetch(n,i),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(a)}}let A=new Set(Object.values(u));async function handle(e,{params:t}){if(console.log("[OpenAI Route] params ",t),"OPTIONS"===e.method)return d.Z.json({body:"OK"},{status:200});let o=t.path.join("/");if(!A.has(o))return console.log("[OpenAI Route] forbidden path ",o),d.Z.json({error:!0,msg:"you are not allowed to request "+o},{status:403});let s=function(e){let t=e.headers.get("Authorization")??"",{accessCode:o,apiKey:s}=function(e){let t=e.trim().replaceAll("Bearer ","").trim(),o=!t.startsWith("nk-");return{accessCode:o?"":t.slice(3),apiKey:o?t:""}}(t),r=g().hash(o??"").trim(),a=(0,p.g)();if(console.log("[Auth] allowed hashed codes: ",[...a.codes]),console.log("[Auth] got access code:",o),console.log("[Auth] hashed access code:",r),console.log("[User IP] ",function(e){let t=e.ip??e.headers.get("x-real-ip"),o=e.headers.get("x-forwarded-for");return!t&&o&&(t=o.split(",").at(0)??""),t}(e)),console.log("[Time] ",new Date().toLocaleString()),a.needCode&&!a.codes.has(r)&&!s)return{error:!0,msg:o?"wrong access code":"empty access code"};if(s)console.log("[Auth] use user api key");else{let t=a.apiKey;t?(console.log("[Auth] use system api key"),e.headers.set("Authorization",`Bearer ${t}`)):console.log("[Auth] admin did not provide an api key")}return{error:!1}}(e);if(s.error)return d.Z.json(s,{status:401});try{let t=await requestOpenai(e);if(o===u.ListModelPath&&200===t.status){let e=await t.json(),o=function(e){let t=(0,p.g)();return t.disableGPT4&&(e.data=e.data.filter(e=>!e.id.startsWith("gpt-4"))),e}(e);return d.Z.json(o,{status:t.status})}return t}catch(e){return console.error("[OpenAI] ",e),d.Z.json(function(e){let t=e;return("string"!=typeof e&&(e=JSON.stringify(e,null,"  ")),"{}"===e)?t.toString():e.startsWith("```json")?e:["```json",e,"```"].join("\n")}(e))}}let v=handle,O=handle,_=new l.AppRouteRouteModule({definition:{kind:c.x.APP_ROUTE,page:"/api/openai/[...path]/route",pathname:"/api/openai/[...path]",filename:"route",bundlePath:"app/api/openai/[...path]/route"},resolvedPagePath:"/Users/hanxie/localproject/ai/fc3-ai-app/fc-qwen/src/code/client/app/api/openai/[...path]/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:P,staticGenerationAsyncStorage:w,serverHooks:b,headerHooks:S,staticGenerationBailout:E}=_,I="/api/openai/[...path]/route"},88436:(e,t,o)=>{o.d(t,{g:()=>getServerSideConfig});var s=o(32825),r=o.n(s);let a=function(){let e=process.env.CODE;try{let t=(e?.split(",")??[]).filter(e=>!!e).map(e=>r().hash(e.trim()));return new Set(t)}catch(e){return new Set}}(),getServerSideConfig=()=>{if("undefined"==typeof process)throw Error("[Server Config] you are importing a nodejs-only module outside of nodejs");return{apiKey:process.env.OPENAI_API_KEY,code:process.env.CODE,codes:a,needCode:a.size>0,baseUrl:process.env.BASE_URL,proxyUrl:process.env.PROXY_URL,isVercel:!!process.env.VERCEL,hideUserApiKey:!!process.env.HIDE_USER_API_KEY,disableGPT4:!!process.env.DISABLE_GPT4,hideBalanceQuery:!!process.env.HIDE_BALANCE_QUERY}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),o=t.X(0,[2825,3955],()=>__webpack_exec__(69463));module.exports=o})();